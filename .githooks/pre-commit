#!/bin/bash

# =============================================================================
# LAUNCHPAD PRE-COMMIT HOOK — Orphan Document Detection
# =============================================================================
#
# This hook scans staged files for "dirty laundry" keywords that indicate
# orphaned documents (session notes, sprint plans, temp files, etc.) that
# should be in _archive/ or _scratch/ instead of permanent locations.
#
# Triggered keywords: SESSION, HANDOFF, SPRINT, PLAN, PHASE, AUDIT, REVIEW,
#                     NOTES, TEMP, WIP, DRAFT, v2, v3, FINAL, OLD, BACKUP,
#                     TODO, SCRATCH, CONTEXT, RECAP, SUMMARY
#
# =============================================================================

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Suspect keywords (case-insensitive patterns)
SUSPECT_PATTERNS=(
    "SESSION"
    "HANDOFF"
    "SPRINT"
    "PHASE"
    "AUDIT"
    "REVIEW"
    "NOTES"
    "TEMP"
    "WIP"
    "DRAFT"
    "FINAL"
    "OLD"
    "BACKUP"
    "TODO"
    "SCRATCH"
    "CONTEXT"
    "RECAP"
    "SUMMARY"
    "_v[0-9]"
    "-v[0-9]"
)

# Allowed locations for suspect files
ALLOWED_PATHS=(
    "_archive/"
    "_scratch/"
    ".githooks/"
    "node_modules/"
)

# Track violations
VIOLATIONS=()

echo ""
echo -e "${CYAN}╔═══════════════════════════════════════════════════════════╗${NC}"
echo -e "${CYAN}║  LAUNCHPAD QCO — Pre-Commit Document Check                ║${NC}"
echo -e "${CYAN}╚═══════════════════════════════════════════════════════════╝${NC}"
echo ""

# Get list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}✓ No files staged for commit${NC}"
    echo ""
    exit 0
fi

# Check each staged file
for FILE in $STAGED_FILES; do
    # Skip if file is in allowed path
    ALLOWED=false
    for ALLOWED_PATH in "${ALLOWED_PATHS[@]}"; do
        if [[ "$FILE" == *"$ALLOWED_PATH"* ]]; then
            ALLOWED=true
            break
        fi
    done

    if [ "$ALLOWED" = true ]; then
        continue
    fi

    # Check filename against suspect patterns
    FILENAME=$(basename "$FILE")
    FILENAME_UPPER=$(echo "$FILENAME" | tr '[:lower:]' '[:upper:]')

    for PATTERN in "${SUSPECT_PATTERNS[@]}"; do
        if [[ "$FILENAME_UPPER" =~ $PATTERN ]]; then
            VIOLATIONS+=("$FILE|$PATTERN")
            break
        fi
    done
done

# Report results
if [ ${#VIOLATIONS[@]} -eq 0 ]; then
    echo -e "${GREEN}✓ All staged files pass governance check${NC}"
    echo ""
    exit 0
else
    echo -e "${RED}✗ GOVERNANCE VIOLATION — Orphan documents detected${NC}"
    echo ""
    echo -e "${YELLOW}The following files have suspect names and are not in _archive/ or _scratch/:${NC}"
    echo ""

    for VIOLATION in "${VIOLATIONS[@]}"; do
        FILE=$(echo "$VIOLATION" | cut -d'|' -f1)
        PATTERN=$(echo "$VIOLATION" | cut -d'|' -f2)
        echo -e "  ${RED}✗${NC} $FILE"
        echo -e "    ${YELLOW}Triggered by:${NC} $PATTERN"
        echo ""
    done

    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}To fix:${NC}"
    echo "  1. Move temp docs to _archive/sessions/, _archive/sprints/, or _archive/audits/"
    echo "  2. Move scratch notes to _scratch/"
    echo "  3. Rename permanent docs to remove suspect keywords"
    echo ""
    echo -e "${YELLOW}To bypass (use sparingly):${NC}"
    echo "  git commit --no-verify"
    echo ""
    echo -e "${CYAN}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""

    exit 1
fi
